CREATE TABLE users (
    id                  INT AUTO_INCREMENT PRIMARY KEY,
    username            VARCHAR(50) NOT NULL UNIQUE,
    password_hash       VARCHAR(255) NOT NULL,
    accepted            BOOLEAN NOT NULL DEFAULT FALSE,
    registration_date   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login          DATETIME,
    total_messages_sent INT DEFAULT 0,
    total_messages_received INT DEFAULT 0
);

CREATE TABLE sessions (
    id                  VARCHAR(64) PRIMARY KEY,
    user_id             INT NOT NULL,
    ip                  VARCHAR(45) NOT NULL,
    connection_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    disconnection_time  DATETIME DEFAULT NULL,
    status              ENUM('CONNECTED', 'DISCONNECTED') NOT NULL DEFAULT 'CONNECTED',
    message_count       INT DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE
);

CREATE TABLE files (
    id              INT AUTO_INCREMENT PRIMARY KEY,
    name            VARCHAR(255) NOT NULL,
    size            BIGINT NOT NULL,
    owner_id        INT NOT NULL,
    path_server     VARCHAR(500),
    mime_type       VARCHAR(100),
    data            LONGBLOB,
    upload_date     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (owner_id) REFERENCES users(id)
        ON DELETE CASCADE
);

CREATE TABLE messages (
    id                  INT AUTO_INCREMENT PRIMARY KEY,
    sender_id           INT NOT NULL,
    receiver_id         INT NOT NULL,
    session_id          VARCHAR(64),
    content_type        ENUM('TEXT', 'FILE') NOT NULL,
    content_text        TEXT,
    content_file_id     INT,
    ip_sender           VARCHAR(45),
    ip_receiver         VARCHAR(45),
    date_sent           DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sender_id) REFERENCES users(id)
        ON DELETE CASCADE,
    FOREIGN KEY (receiver_id) REFERENCES users(id)
        ON DELETE CASCADE,
    FOREIGN KEY (content_file_id) REFERENCES files(id)
        ON DELETE SET NULL,
    FOREIGN KEY (session_id) REFERENCES sessions(id)
        ON DELETE SET NULL
);

